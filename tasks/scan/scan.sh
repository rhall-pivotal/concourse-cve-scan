#!/usr/bin/env bash

set -euox pipefail

cd $TARGET_REPO

syft packages \
    --output=cyclonedx-json \
    --file=../$TARGET_REPO.sbom \
    dir:.

if [[ "$GRYPE_FAILURE_LEVEL" == "none" || "$GRYPE_FAILURE_LEVEL" == "None" || "$GRYPE_FAILURE_LEVEL" == "NONE"]]
then
    # No fail mode
    grype --add-cpes-if-none \
        sbom:../$TARGET_REPO.sbom
else
    grype --add-cpes-if-none \
        --fail-on $GRYPE_FAILURE_LEVEL \
        sbom:../$TARGET_REPO.sbom
fi

if [[ -z "$DRY_RUN" || \
    "$DRY_RUN" == "false" || \   
    "$DRY_RUN" == "False" || \
    "$DRY_RUN" == "FALSE"]]
then
cd ..
tar_location="$(ls tas-cve/tas-cve-*.tgz)"
tar -xvzf $tar_location
chmod +x tas-cve/linux_x86-64/tas-cve
./tas-cve/linux_x86-64/tas-cve uploadBom \
    --bom $TARGET_REPO.sbom \
    --name $RELEASE_NAME \
    --version $RELEASE_VERSION
else
    echo "DRY_RUN enabled, skipping tas-cve uploadBom."
fi

echo "Sleeping for 10 Minutes"
sleep 10m

exit 1