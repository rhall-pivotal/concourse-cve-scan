#!/usr/bin/env bash

set -euox pipefail

# dir='dir:'
# pwd="$(pwd)"
# grype_dir_path="$dir""$pwd"/$SCAN_REPO
# grype $grype_dir_path

cd $SCAN_REPO

syft packages \
    --output=cyclonedx-json \
    --file=../$SCAN_REPO.sbom \
    dir:.

grype --add-cpes-if-none \
    sbom:../$SCAN_REPO.sbom

cd ..
pwd
ls
tar_location="$(ls tas-cve/tas-cve-*.tgz)"
tar -xvzf $tar_location
chmod +x tas-cve/linux_x86-64/tas-cve
./tas-cve/linux_x86-64/tas-cve uploadBom \
    --bom $SCAN_REPO.sbom \
    --name $RELEASE_NAME \
    --version $RELEASE_VERSION


echo "Sleeping"

sleep 10m

exit 1