#!/usr/bin/env bash

set -euox pipefail

cd $TARGET_REPO

syft packages \
    --output=cyclonedx-json \
    --file=../$TARGET_REPO.sbom \
    dir:.

if [ "$GRYPE_FAILURE_LEVEL" = 'none' ]
then
    # No fail mode
    grype --add-cpes-if-none \
        sbom:../$TARGET_REPO.sbom
else
    # Grype will 'exit 1' if cve meets/exceeds level
    grype --add-cpes-if-none \
        --fail-on $GRYPE_FAILURE_LEVEL \
        sbom:../$TARGET_REPO.sbom
fi

if [ "$DRY_RUN" = 'true' ]
then
    echo "DRY_RUN enabled, skipping tas-cve uploadBom."
else
    cd ..
    tar_location="$(ls tas-cve/tas-cve-*.tgz)"
    tar -xvzf $tar_location
    chmod +x tas-cve/linux_x86-64/tas-cve
    ./tas-cve/linux_x86-64/tas-cve uploadBom \
        --bom $TARGET_REPO.sbom \
        --name $RELEASE_NAME \
        --version $RELEASE_VERSION
fi

echo "Sleeping for 10 Minutes"
sleep 10m

exit 1